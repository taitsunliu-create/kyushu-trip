<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¹å·è¦ªå­è‡ªé§•éŠ 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563EB;      /* ä¸»è‰²è— */
            --secondary: #F59E0B;    /* è¼”è‰²é»ƒ */
            --bg: #F3F4F6;           /* èƒŒæ™¯ç° */
            --white: #FFFFFF;
            --text-main: #1F2937;
            --text-sub: #6B7280;
            --danger: #EF4444;
            --food-choice: #8B5CF6;
            --tag-food-bg: #EDE9FE;
            --tag-toyota: #E0E7FF;
            --info-bg: #E0F2F1;
            --info-text: #0D9488;
            --kumamoto-info-bg: #F0F9FF;
            --kumamoto-info-text: #0E7490;
            --beppu-info: #14B8A6;
            --beppu-bg: #E0F2F1;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: calc(80px + var(--safe-area-bottom));
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: var(--white);
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
            position: relative;
            z-index: 10;
        }
        
        .header-content {
            display: flex;
            flex-direction: row; 
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            max-width: 1200px;
            margin: 0 auto;
            flex-wrap: wrap; 
        }

        .header-title-area { flex: 1; min-width: 200px; }
        .header-title-area h1 { margin: 0; font-size: 1.6rem; font-weight: 700; white-space: nowrap; }
        .header-title-area .subtitle { font-size: 0.9rem; opacity: 0.9; margin-top: 5px; }
        .header-title-area .badge-trip { 
            background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; 
            font-size: 0.8rem; display: inline-block; margin-top: 8px;
        }

        /* Weather Box */
        .header-weather-box {
            flex: 0 0 auto; 
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 70px;
        }

        .hw-col-loc { padding-right: 15px; border-right: 1px solid rgba(255,255,255,0.3); text-align: center; min-width: 80px; }
        .hw-loc { font-size: 1.1rem; font-weight: 700; display: block; line-height: 1.2; }
        .hw-date { font-size: 0.75rem; opacity: 0.9; display: block; margin-top: 4px; }

        .hw-col-main { padding: 0 15px; display: flex; align-items: center; gap: 10px; }
        
        /* [ä¿®æ”¹] èª¿æ•´åœ–ç¤ºå¤§å°ä»¥é©æ‡‰ Emoji */
        .hw-icon { font-size: 2.2rem; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        
        .hw-temp-group { text-align: center; }
        .hw-temp { font-size: 1.4rem; font-weight: 700; line-height: 1; }
        .hw-desc { font-size: 0.8rem; font-weight: 500; display: block; margin-top: 2px; }
        .hw-range { font-size: 0.7rem; opacity: 0.9; display: block; margin-top: 2px; font-family: monospace; }

        .hw-col-advice {
            padding-left: 15px; border-left: 1px solid rgba(255,255,255,0.3);
            max-width: 140px; font-size: 0.75rem; line-height: 1.3; opacity: 0.95;
            display: flex; align-items: center; min-height: 50px;
        }

        /* Container & Tabs */
        .container { display: none; padding: 20px; animation: fadeIn 0.3s ease; max-width: 800px; margin: 0 auto; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: var(--white); border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.03); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .card-title { font-weight: 700; color: var(--primary); font-size: 1.05rem; }

        /* Day specific styles */
        .day-wrapper { background: var(--white); border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .day-toggle {
            display: flex; justify-content: space-between; align-items: center; padding: 15px; cursor: pointer;
            border-radius: 12px; border-left: 5px solid transparent; transition: background-color 0.2s, border-left-color 0.3s;
        }
        .day-toggle:active { background-color: #F8F9FB; }
        .day-toggle.open { border-left-color: var(--primary); }
        .day-info h3 { margin: 0; font-size: 1.1rem; color: var(--text-main); }
        .day-info span { font-size: 0.85rem; color: var(--text-sub); }
        .toggle-icon { transition: transform 0.3s; font-size: 0.8rem; color: var(--text-sub); font-weight: 700; }
        .day-toggle.open .toggle-icon { transform: rotate(180deg); color: var(--primary); }

        .timeline { display: none; padding: 15px 15px 5px 30px; border-top: 1px solid #F3F4F6; }
        .timeline.show { display: block; }

        .event { position: relative; padding-left: 20px; margin-bottom: 24px; }
        .event:last-child { margin-bottom: 0; }
        .event::before {
            content: ''; position: absolute; left: -7px; top: 6px;
            width: 12px; height: 12px; border-radius: 50%;
            background: var(--white); border: 3px solid var(--secondary); z-index: 1;
        }
        
        .event-meal .activity { color: var(--food-choice); }
        .event-meal .desc { border-left: 2px solid var(--food-choice); padding-left: 8px; margin-top: 5px; }
        .time { font-size: 0.85rem; color: var(--text-sub); font-weight: 600; font-family: monospace; }
        .activity { font-size: 1rem; font-weight: 700; margin: 4px 0; color: var(--text-main); }
        .desc { font-size: 0.9rem; color: #555; line-height: 1.5; margin-bottom: 8px; }

        /* Tags */
        .tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 6px; font-weight: 500; }
        .tag-food { background: var(--tag-food-bg); color: var(--food-choice); }
        .tag-move { background: #DBEAFE; color: #1E40AF; }
        .tag-stay { background: #D1FAE5; color: #059669; }
        .tag-spot { background: #FCE7F3; color: #BE185D; }
        .tag-kids { background: #E0F2FE; color: #0284C7; border: 1px solid #BAE6FD; }
        .tag-car { background: var(--tag-toyota); color: #4338CA; }
        .tag-relax { background: #FFFBEB; color: #D97706; border: 1px solid #FCD34D; }
        .tag-shrine { background: #FEE2E2; color: #B91C1C; border: 1px solid #FCA5A5; }
        .tag-flight { background: #BFDBFE; color: #1D4ED8; }
        .tag-tip { background: var(--info-bg); color: var(--info-text); }
        .tag-shop { background: var(--kumamoto-info-bg); color: var(--kumamoto-info-text); }
        .tag-beppu { background: var(--beppu-bg); color: var(--beppu-info); }
        .tag-snow { background: #E0F2FE; color: #0369A1; border: 1px solid #BAE6FD; }

        /* Buttons */
        .btn-map { display: inline-flex; align-items: center; text-decoration: none; color: var(--primary); font-size: 0.85rem; font-weight: 600; margin-top: 4px; padding: 4px 0; }
        .btn-map::before { content: 'ğŸ“'; margin-right: 4px; }
        .btn-link { background: var(--primary); color: white; text-decoration: none; padding: 10px 16px; border-radius: 8px; font-size: 0.9rem; display: block; text-align: center; margin-top: 10px; }
        .btn-link-sub { background: #EBF5FF; color: var(--primary); text-decoration: none; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; display: block; text-align: center; margin-top: 8px; border: 1px solid var(--primary); }
        .btn-link-tel { background: #D1FAE5; color: #059669; text-decoration: none; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; display: block; text-align: center; margin-top: 8px; border: 1px solid #059669; }
        .btn-link-tel::before { content: 'ğŸ“'; margin-right: 4px; }

        /* Info Grid */
        .info-grid { display: grid; grid-template-columns: 100px 1fr; gap: 10px; font-size: 0.9rem; margin-bottom: 8px; }
        .info-label { color: var(--text-sub); }
        .info-val { font-weight: 500; }
        .info-detail-box { border: 1px solid #D1D5DB; padding: 12px; border-radius: 8px; margin-top: 10px; }
        .info-detail-box h4 { margin: 0 0 8px 0; font-size: 1rem; color: var(--primary); }

        .info-section { background-color: var(--info-bg); padding: 15px; border-radius: 12px; margin-bottom: 16px; border: 1px solid #5EEAD4; }
        .info-section.kumamoto { background-color: var(--kumamoto-info-bg); border-color: #90CDF4; }
        .info-section.kumamoto h3 { color: var(--kumamoto-info-text); border-bottom: 2px solid #90CDF4; }
        .info-section.winter-drive { background-color: #FEF2F2; border-color: #FCA5A5; color: #B91C1C; }
        .info-section.winter-drive h3 { color: #B91C1C; border-bottom: 2px solid #FCA5A5; }
        .info-section h3 { color: var(--info-text); font-size: 1.2rem; margin-top: 0; border-bottom: 2px solid #5EEAD4; padding-bottom: 5px; margin-bottom: 15px; }

        .price-table { display: grid; grid-template-columns: 1fr 80px 80px; gap: 8px; font-size: 0.9rem; margin-top: 10px; }
        .price-header { font-weight: 700; color: var(--primary); padding-bottom: 4px; border-bottom: 1px solid var(--primary); }
        .price-item { padding: 4px 0; border-bottom: 1px dashed #DDD; }
        .price-item:last-child { border-bottom: none; }
        .price-item .detail { font-size: 0.8rem; color: var(--text-sub); }

        .safari-method { margin-top: 15px; padding: 10px; border-radius: 8px; border: 1px dashed var(--info-text); }
        .method-title { font-weight: 700; color: var(--primary); display: block; margin-bottom: 5px; font-size: 1rem; }
        .method-title.recommended { color: var(--danger); }
        .method-detail { font-size: 0.9rem; line-height: 1.5; color: #444; }

        .step-list { counter-reset: step-counter; padding-left: 0; list-style: none; margin-top: 10px; }
        .step-list li { position: relative; padding-left: 30px; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.5; }
        .step-list li::before {
            counter-increment: step-counter; content: counter(step-counter);
            position: absolute; left: 0; top: 0; width: 20px; height: 20px;
            background-color: var(--primary); color: white; border-radius: 50%;
            text-align: center; font-size: 0.75rem; line-height: 20px;
        }

        /* Bottom Nav - Optimized for Safe Area */
        .nav-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            border-top: 1px solid #eee; display: flex; justify-content: space-around; 
            padding: 8px 0 calc(8px + var(--safe-area-bottom)); 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; 
        }
        .nav-item { 
            text-align: center; color: #9CA3AF; font-size: 0.7rem; cursor: pointer; 
            transition: color 0.2s; flex-grow: 1; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; padding: 4px;
        }
        .nav-item.active { color: var(--primary); }
        
        /* [ä¿®æ”¹] å°èˆªåœ–ç¤ºæ”¹ç‚ºç´”æ–‡å­— (Emoji) æ¨£å¼ */
        .nav-icon { 
            display: block; margin-bottom: 4px; 
            font-size: 1.4rem; /* æ”¾å¤§ Emoji */
            line-height: 1;
            height: auto; width: auto;
        }

        .alert-box { background: #FEF2F2; border: 1px solid #FECACA; color: #991B1B; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-top: 8px; display: flex; gap: 8px; align-items: start; margin-bottom: 15px; }
        .event.optimized { border-left: 2px solid var(--secondary); padding-left: 28px; margin-left: -8px; background-color: #FFFDF5; padding-top: 5px; padding-bottom: 5px; border-radius: 4px; }
        
        .btn-ai-guide {
            background: linear-gradient(90deg, #8B5CF6, #EC4899); color: white; border: none;
            padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; cursor: pointer;
            margin-top: 10px; display: inline-flex; align-items: center; gap: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; font-weight: 600;
        }
        .btn-ai-guide:active { transform: scale(0.95); }

        .weather-search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .weather-input { flex: 1; padding: 12px; border: 2px solid #E5E7EB; border-radius: 12px; font-size: 1rem; outline: none; }
        .weather-input:focus { border-color: var(--primary); }
        .btn-weather-search { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 12px; font-weight: 600; cursor: pointer; }
        
        .weather-card-main {
            background: linear-gradient(135deg, #60A5FA, #2563EB); color: white; 
            border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; 
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); position: relative; overflow: hidden;
        }
        .weather-card-main::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%);
            animation: rotate 20s linear infinite;
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .wc-temp-big { font-size: 4rem; font-weight: 700; line-height: 1; margin: 10px 0; position: relative; z-index: 1; }
        .wc-loc { font-size: 1.5rem; font-weight: 500; position: relative; z-index: 1; }
        .wc-desc { 
            font-size: 1.1rem; opacity: 0.9; margin-bottom: 10px; position: relative; z-index: 1;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        /* [ä¿®æ”¹] è¿·ä½ åœ–ç¤º (ç”¨æ–¼å¤©æ°£é é¢å°æ¨™é¡Œ) */
        .icon-mini {
            font-size: 1.1rem;
            margin-right: 4px;
            vertical-align: middle;
            display: inline-block;
            line-height: 1;
        }

        .weather-compare-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .wc-mini-card {
            flex: 1; background: white; padding: 15px; border-radius: 16px; border: 1px solid #E5E7EB; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .wc-mini-title { font-size: 0.85rem; color: #6B7280; margin-bottom: 5px; }
        .wc-mini-temp { font-size: 1.5rem; font-weight: 700; color: #1F2937; }
        .wc-diff-tag { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; margin-top: 5px; }
        .wc-diff-hot { background: #FEE2E2; color: #DC2626; }
        .wc-diff-cold { background: #DBEAFE; color: #1D4ED8; }
        
        .advice-box { background: #F0FDF4; border: 1px solid #BBF7D0; padding: 15px; border-radius: 16px; color: #166534; font-size: 0.95rem; line-height: 1.6; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 2000;
            display: none; justify-content: center; align-items: center;
            backdrop-filter: blur(3px); animation: fadeIn 0.2s;
        }
        .modal-box {
            background: white; width: 90%; max-width: 320px;
            border-radius: 16px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center; transform: scale(0.95); animation: popIn 0.2s forwards;
        }
        @keyframes popIn { to { transform: scale(1); } }
        
        .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; color: #1F2937; }
        .modal-desc { font-size: 0.9rem; color: #4B5563; margin-bottom: 15px; line-height: 1.5; }
        .modal-input { width: 100%; padding: 10px; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 1rem; margin-bottom: 15px; outline: none; }
        .modal-input:focus { border-color: var(--primary); }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #F3F4F6; color: #4B5563; }
        .btn-confirm { background: var(--primary); color: white; }

        /* AI Container */
        .ai-header { font-size: 1.4rem; font-weight: 700; margin-bottom: 15px; color: #4B5563; display: flex; align-items: center; gap: 8px; border-bottom: 2px solid #E5E7EB; padding-bottom: 10px; }
        
        .chat-history {
            background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 16px;
            padding: 16px; min-height: 200px; flex: 1; overflow-y: auto;
            margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }

        .chat-row { display: flex; width: 100%; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .chat-row.user { justify-content: flex-end; }
        .chat-row.ai { justify-content: flex-start; }

        .chat-bubble { max-width: 85%; padding: 12px 16px; font-size: 1rem; line-height: 1.6; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-bubble.user { background: var(--primary); color: white; border-radius: 18px 18px 4px 18px; }
        .chat-bubble.ai { background: white; border: 1px solid #E5E7EB; color: #374151; border-radius: 18px 18px 18px 4px; }
        .chat-bubble strong { font-weight: 600; }
        .chat-bubble.ai strong { color: var(--primary); }

        .btn-audio-inline {
            display: inline-flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; background: #E0F2FE; color: var(--primary);
            border-radius: 50%; border: none; cursor: pointer; vertical-align: middle;
            margin-left: 8px; transition: transform 0.2s; font-size: 0.9rem;
        }
        .btn-audio-inline:active { transform: scale(0.9); background: #BAE6FD; }

        .ai-input-wrapper { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        
        .voice-lang-switch { display: flex; align-items: center; gap: 15px; margin-bottom: -5px; padding: 0 5px; font-size: 0.85rem; color: #4B5563; }
        .lang-option {
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            padding: 6px 12px; border-radius: 20px; border: 1px solid transparent; transition: all 0.2s; background: #fff;
        }
        .lang-option:hover { background: #F3F4F6; }
        .lang-option input { display: none; }
        .lang-option:has(input:checked) { background: #EFF6FF; border-color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        /* [ä¿®æ”¹] åœ‹æ——æ”¹ç‚º Emoji æ–‡å­— */
        .flag-icon { font-size: 1.4rem; line-height: 1; }

        .ai-input {
            width: 100%; padding: 14px; border: 2px solid #E5E7EB; border-radius: 12px; outline: none; 
            font-size: 16px; transition: border-color 0.2s;
        }
        .ai-input:focus { border-color: #3b82f6; }

        .ai-actions-row { display: flex; gap: 8px; width: 100%; }
        
        .btn-mode {
            flex: 1; padding: 12px; border: none; border-radius: 12px; color: white;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 8px; font-size: 0.95rem; transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 48px;
            -webkit-user-select: none; -moz-user-select: none; user-select: none; -webkit-touch-callout: none; touch-action: manipulation;
        }
        .btn-mode:active { transform: scale(0.96); opacity: 0.9; }
        
        /* [ä¿®æ”¹] æŒ‰éˆ•å…§åœ–ç¤ºç§»é™¤ SVG å¯¬é«˜è¨­å®šï¼Œæ”¹ç”¨æ–‡å­—å¤§å° */
        .btn-mode-icon { font-size: 1.2rem; margin-right: 4px; }

        .btn-mode.consult { background: linear-gradient(135deg, #1D4ED8, #3B82F6); }
        .btn-mode.trans { background: linear-gradient(135deg, #0EA5E9, #38BDF8); }
        .btn-mode.voice { background: linear-gradient(135deg, #06B6D4, #22D3EE); }
        
        .btn-mode.voice.recording {
            background: linear-gradient(135deg, #EF4444, #F87171); 
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        .btn-ai-reset {
            background: #F3F4F6; color: #6B7280; border: 1px solid #D1D5DB;
            padding: 10px 16px; border-radius: 8px; font-size: 0.9rem;
            cursor: pointer; margin-bottom: 15px; display: none; align-self: flex-end; width: 100%; text-align: center;
        }
        .btn-ai-reset:hover { background: #E5E7EB; }

        .loading-bubble { color: #9CA3AF; font-style: italic; font-size: 0.9rem; display: flex; align-items: center; gap: 4px; }
        .loading-dots:after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ' ....'; } }

        /* Mobile Optimization */
        @media (max-width: 600px) {
            .container { padding: 15px 12px; }
            .header-content { flex-direction: column; align-items: flex-start; gap: 10px; }
            .header-title-area h1 { font-size: 1.5rem; white-space: normal; line-height: 1.3; }
            
            .header-weather-box { 
                width: 100%; justify-content: space-between; padding: 10px 15px; border-radius: 12px;
                background: rgba(255, 255, 255, 0.15); min-height: auto; flex-wrap: wrap; gap: 8px;
            }
            .hw-col-advice { 
                display: block; width: 100%; border-left: none; border-top: 1px solid rgba(255,255,255,0.3);
                padding-left: 0; padding-top: 8px; max-width: none; min-height: auto; font-size: 0.8rem; line-height: 1.4;
            }
            .hw-col-main { flex-grow: 1; justify-content: flex-end; }
            .hw-col-loc { min-width: auto; border: none; padding-right: 0; text-align: left; }
            
            .timeline { padding-left: 15px; padding-right: 5px; } 
            .event { padding-left: 15px; }
            .event::before { left: -6px; }

            .ai-actions-row { gap: 8px; }
            .btn-mode {
                padding: 10px 4px; font-size: 0.8rem; flex-direction: column; gap: 6px; line-height: 1.2; height: 70px;
            }
            .btn-mode-icon { font-size: 1.5rem; margin-right: 0; margin-bottom: 2px; }
            .price-table { font-size: 0.85rem; }
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <div class="header-title-area">
                <h1>ä¹å·è¦ªå­è‡ªé§•éŠ</h1>
                <div class="subtitle">2026/01/25 - 01/30 (6å¤©5å¤œ)</div>
                <div class="badge-trip">ğŸ‘¨â€ğŸ‘©â€ğŸ‘¦ è¦ªå­è‡ªç”±è¡Œ â€¢ ç†Šæœ¬é€²ç¦å²¡å‡º</div>
            </div>

            <div class="header-weather-box" id="header-weather">
                <div class="hw-col-loc">
                    <span class="hw-loc" id="hw-loc">ç†Šæœ¬å¸‚</span>
                    <span class="hw-date" id="hw-date">1/25 (Day 1)</span>
                </div>
                <div class="hw-col-main">
                    <div class="hw-icon" id="hw-icon">
                        ğŸŒ¥ï¸ </div>
                    <div class="hw-temp-group">
                        <div class="hw-temp" id="hw-temp">10Â°C</div>
                        <span class="hw-desc" id="hw-desc">æ™´æ™‚å¤šé›²</span>
                        <span class="hw-range" id="hw-range">2Â°C ~ 11Â°C</span>
                    </div>
                </div>
                <div class="hw-col-advice" id="hw-advice">
                    æ°£æº«é©ä¸­ä½†æ—©æ™šåæ¶¼ï¼Œé•·è¢–é…å¤–å¥—ã€‚
                </div>
            </div>
        </div>
    </header>

    <div id="view-schedule" class="container active">
        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d1" onclick="toggleTimeline('d1', this)">
                <div class="day-info">
                    <h3>Day 1: æŠµé”èˆ‡ç†Šæœ¬å¸‚å€</h3>
                    <span>1/25 (æ—¥) â€¢ ä½å®¿: The Blossom</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d1" class="timeline">
                <div class="event">
                    <div class="time">11:00</div>
                    <div class="activity">æŠµé”ç†Šæœ¬æ©Ÿå ´ (KMJ)</div>
                    <div class="desc">é ˜å–è¡Œæå¾Œï¼Œå‰å¾€1æ¨“å…¥å¢ƒå¤§å»³å¤– 4è™Ÿä¹˜è»Šè™•ã€‚</div>
                    <div class="tags"><span class="tag tag-move">æ˜Ÿå®‡èˆªç©º</span></div>
                </div>
                <div class="event">
                    <div class="time">12:00</div>
                    <div class="activity">å‰å¾€ç†Šæœ¬å¸‚å€ (äº¤é€šé¸æ“‡)</div>
                    <div class="desc">
                        <ul style="list-style-type: disc; padding-left: 20px;">
                            <li><b>é¸é … A (ç›´é”å·´å£«)ï¼š</b> æ­ä¹˜åˆ©æœ¨æ´¥å·´å£«å¾€ã€Œç†Šæœ¬ç«™ã€ã€‚è»Šç¨‹ç´„60åˆ†ï¼Œæˆäººç´„1000å††ã€‚æœ€è¼•é¬†ï¼Œè¡Œæå…æ¬é‹ã€‚</li>
                            <li><b>é¸é … B (å…è²»æ¥é§+JR)ï¼š</b> æ­ä¹˜å…è²»ã€Œç©ºæ¸¯Linerã€è‡³è‚¥å¾Œå¤§æ´¥ç«™ (15åˆ†)ï¼Œè½‰ä¹˜ JR è±è‚¥æœ¬ç·šè‡³ç†Šæœ¬ç«™ (40åˆ†ï¼Œç´„480å††)ã€‚ä¸æ€•å¡è»Šï¼Œä½†éœ€è½‰ä¹˜ã€‚</li>
                            <li><b>é¸é … C (è¨ˆç¨‹è»Š)ï¼š</b> ç›´æ¥å‰å¾€é£¯åº—ï¼Œè»Šç¨‹ç´„ 45-50 åˆ†ï¼Œè»Šè³‡ç´„ 5000-6000å††ã€‚</li>
                        </ul>
                    </div>
                    <div class="tags"><span class="tag tag-move">å·´å£«</span><span class="tag tag-move">JRé›»è»Š</span></div>
                </div>
                <div class="event">
                    <div class="time">13:10</div>
                    <div class="activity">é£¯åº— Check-in / å¯„æ”¾è¡Œæ</div>
                    <div class="desc">The Blossom Kumamoto (JRç†Šæœ¬ç«™æ— Amu Plazaæ¨“ä¸Š)ã€‚</div>
                    <a href="https://www.google.com/maps/search/?api=1&query=THE+BLOSSOM+KUMAMOTO" target="_blank" class="btn-map">å°èˆª</a>
                </div>
                <div class="event event-meal">
                    <div class="time">13:30</div>
                    <div class="activity">åˆé¤/é»å¿ƒæ™‚æ®µï¼šç†Šæœ¬ç«™å‘¨é‚Š</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>è‚¥å¾Œå¥½ç‰©å¸‚å ´ï¼šï¼š</b> (ç†Šæœ¬ç«™å…§) æ¨è–¦ï¼šã„ããªã‚Šå›£å­ (é•·å£½åºµ)ã€ç«¹è¼ªæ²™æ‹‰ (ãƒ’ãƒ©ã‚¤)ã€‚å¿«é€Ÿè§£æ±ºã€‚</li>
                            <li><b>ç†Šæœ¬æ‹‰éºµï¼šï¼š</b> ç«™å‰æœ‰å¹¾é–“æ‹‰éºµåº—ï¼Œå¯å¿«é€Ÿé£½é¤ä¸€é “ã€‚</li>
                        </ul>
                    </div>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡åˆé¤</span></div>
                </div>
                <div class="event">
                    <div class="time">15:00</div>
                    <div class="activity">ç†Šæœ¬åŸ / æ«»ä¹‹é¦¬å ´ åŸå½©è‹‘</div>
                    <div class="desc">
                        æ¬£è³å¤©å®ˆé–£å¤–è§€(ä¿®å¾©ä¸­)ï¼ŒåŸå½©è‹‘æœ‰è¨±å¤šè©¦åƒèˆ‡ç´€å¿µå“ã€‚
                        <div style="margin-top: 8px; border-top: 1px dashed #ccc; padding-top: 5px;">
                            <strong style="color: var(--food-choice); font-size: 0.9rem;">ğŸ˜‹ åŸå½©è‹‘å¿…åƒæ¨è–¦ï¼š</strong>
                            <ul style="list-style-type: disc; margin-top: 5px; padding-left: 20px; font-size: 0.9rem; color: #555;">
                                <li><b>æµ·è†½å¯æ¨‚é¤… (ã†ã«ã‚³ãƒ­ãƒƒã‚±)ï¼š</b> æ¿ƒéƒæµ·è†½å…§é¤¡ï¼Œå¤–é…¥å…§è»Ÿã€‚</li>
                                <li><b>è…ä¹ƒå±‹ é¦¬è‚‰å¯æ¨‚é¤…ï¼š</b> ä¸æ•¢åƒç”Ÿé¦¬è‚‰å¯ä»¥å˜—è©¦é€™å€‹ï¼Œç„¡è…¥å‘³ã€‚</li>
                                <li><b>æŠ¹èŒ¶éœœæ·‡æ·‹ (TENTE)ï¼š</b> ç†Šæœ¬ç”¢èŒ¶è‘‰è£½ä½œï¼ŒèŒ¶é¦™æ¿ƒåšã€‚</li>
                            </ul>
                        </div>
                    </div>
                    <button class="btn-ai-guide" onclick="askGeminiGuide('ç†Šæœ¬åŸå¤©å®ˆé–£èˆ‡å¿è€…', 'å‘Šè¨´5æ­²å°å­©é—œæ–¼é€™åº§åŸå ¡çš„å¿è€…æ•…äº‹æˆ–æ­¦å£«æ•…äº‹ï¼Œä¸¦çµ¦ä»–ä¸€å€‹å°‹æ‰¾åŸç‰†ä¸Šç‰¹æ®ŠçŸ³é ­çš„ä»»å‹™ã€‚')">
                        âœ¨ èªªæ•…äº‹çµ¦å­©å­è½
                    </button>
                    <a href="https://www.google.com/maps/search/?api=1&query=Sakuranobaba+Josaien" target="_blank" class="btn-map">å°èˆª</a>
                    <div class="tags"><span class="tag tag-spot">è¦ªå­æ•£æ­¥</span><span class="tag tag-food">é‚Šèµ°é‚Šåƒ</span></div>
                </div>
                <div class="event">
                    <div class="time">19:30</div>
                    <div class="activity">æ™šé¤æ™‚æ®µï¼šç†Šæœ¬å¸‚å€/è»Šç«™é¸æ“‡</div>
                    <div class="desc">
                        <ul style="list-style-type: disc;">
                            <li><b>å‹çƒˆäº­è±¬æ’ï¼šï¼š</b> (æ–°å¸‚è¡—/Amu Plaza) çŸ¥åæ—¥å¼è±¬æ’è€åº—ï¼Œç™½é£¯é«˜éº—èœå¯çºŒã€‚</li>
                            <li><b>å¤©å¤–å¤©æ‹‰éºµï¼šï¼šï¼š</b> (æ–°å¸‚è¡—) çŸ¥åè’œå‘³è±šéª¨æ‹‰éºµï¼Œé‡å£å‘³ã€‚</li>
                        </ul>
                    </div>
                    <a href="https://www.google.com/maps/search/?api=1&query=Katsuretsutei+Amu+Plaza+Kumamoto" target="_blank" class="btn-map">å‹çƒˆäº­å°èˆª</a>
                    <div class="tags"><span class="tag tag-food">é¸æ“‡æ™šé¤</span></div>
                </div>
                </div>
        </div>
        
        <div class="day-wrapper">
             <div class="day-toggle" id="toggle-d2" onclick="toggleTimeline('d2', this)">
                <div class="day-info">
                    <h3>Day 2: è§€å…‰åˆ—è»Š & é»‘å·æº«æ³‰</h3>
                    <span>1/26 (ä¸€) â€¢ ä½å®¿: é»‘å·æº«æ³‰</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
             <div id="d2" class="timeline">
                 <div class="event">
                    <div class="time">09:57</div>
                    <div class="activity">JR è§€å…‰åˆ—è»Šã€Œé˜¿è˜‡ç”·å­©!ã€</div>
                    <div class="desc">
                        ç¬¬3ç¯€è»Šå»‚è¨­æœ‰**æœ¨çƒæ± ã€å…’ç«¥åœ–æ›¸å®¤**å’Œå“ºä¹³å®¤ï¼Œè«‹é ç•™æ™‚é–“å¸¶å­©å­å»ç©ã€‚
                    </div>
                    <button class="btn-ai-guide" onclick="askGeminiGuide('é˜¿è˜‡ç”·å­©è™Ÿåˆ—è»Š', 'å‘å­©å­ä»‹ç´¹é€™å°ç«è»Šä¸Šçš„å°ç‹— Kuro é†¬æ˜¯èª°ï¼Œä¸¦å»ºè­°ä¸€å€‹åœ¨ç«è»Šä¸Šå¯ä»¥ç©çš„å°‹å¯¶éŠæˆ²ã€‚')">
                        âœ¨ Kuro é†¬æ˜¯èª°ï¼Ÿ
                    </button>
                    <div class="tags"><span class="tag tag-move">ç«è»Š</span><span class="tag tag-kids">è¦ªå­å¿…éŠ</span></div>
                </div>
                 </div>
        </div>

        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d3" onclick="toggleTimeline('d3', this)">
                <div class="day-info">
                    <h3>Day 3: åˆ¥åºœæµ·åœ°ç„ã€é‡ç”Ÿå‹•ç‰©åœ’ & ç”±å¸ƒé™¢</h3>
                    <span>1/27 (äºŒ) â€¢ ä½å®¿: ç”±å¸ƒé™¢</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d3" class="timeline">
                <div class="event">
                    <div class="time">14:30 - 17:30</div>
                    <div class="activity">ä¹å·è‡ªç„¶å‹•ç‰©å…¬åœ’ (3å°æ™‚éŠç©)</div>
                    <div class="desc">
                        **æ™‚é–“å»ºè­°ï¼š** è‡ªé§•è§€è³ (30åˆ†é˜) + å¢æ—å·´å£« (50åˆ†é˜) + è¦ªè¿‘å€ (1å°æ™‚30åˆ†é˜)ã€‚
                    </div>
                    <button class="btn-ai-guide" onclick="askGeminiGuide('ä¹å·è‡ªç„¶å‹•ç‰©å…¬åœ’', 'è«‹ç”¨èª‡å¼µæœ‰è¶£çš„èªæ°£ï¼Œå‘Šè¨´å­©å­ç­‰ä¸€ä¸‹æœƒçœ‹åˆ°ç…å­è€è™å°±åœ¨è»Šå­æ—é‚Šï¼Œä¸¦æé†’ä»–å€‘è¦æ³¨æ„çœ‹ä»€éº¼å‹•ç‰©çš„ç‰™é½’ã€‚')">
                        âœ¨ å•Ÿå‹•æ¢éšªæ¨¡å¼
                    </button>
                    <div class="tags"><span class="tag tag-kids">è¦ªå­å¿…éŠ</span><span class="tag tag-spot">å‹•ç‰©åœ’</span></div>
                </div>
                </div>
        </div>

        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d4" onclick="toggleTimeline('d4', this)">
                <div class="day-info">
                    <h3>Day 4: ç”±å¸ƒé™¢è‡³ç¦å²¡</h3>
                    <span>1/28 (ä¸‰) â€¢ ä½å®¿: ç¦å²¡</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d4" class="timeline">
                 </div>
        </div>

        <div class="day-wrapper">
             <div class="day-toggle" id="toggle-d5" onclick="toggleTimeline('d5', this)">
                <div class="day-info">
                    <h3>Day 5: å¤ªå®°åºœèˆ‡ç¦å²¡è³¼ç‰©</h3>
                    <span>1/29 (å››) â€¢ ä½å®¿: ç¦å²¡</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
            <div id="d5" class="timeline">
                </div>
        </div>

        <div class="day-wrapper">
            <div class="day-toggle" id="toggle-d6" onclick="toggleTimeline('d6', this)">
                <div class="day-info">
                    <h3>Day 6: è³¼ç‰©èˆ‡è¿”ç¨‹</h3>
                    <span>1/30 (äº”) â€¢ æº«æš–çš„å®¶</span>
                </div>
                <div class="toggle-icon">â–¼</div>
            </div>
             <div id="d6" class="timeline">
                <div class="event">
                    <div class="time">10:00</div>
                    <div class="activity">å‰å¾€ LaLaport ç¦å²¡</div>
                    <div class="desc">
                        ç¦å²¡æœ€æ–°å¤§å‹è³¼ç‰©ä¸­å¿ƒï¼Œå¿…çœ‹ <b>1:1 å¯¦é«”å¤§é‹¼å½ˆç«‹åƒ</b>ï¼
                    </div>
                    <button class="btn-ai-guide" onclick="askGeminiGuide('RX-93ff Î½é‹¼å½ˆ', 'ç°¡å–®ä»‹ç´¹é€™å€‹å·¨å¤§çš„æ©Ÿå™¨äººæœ‰å¤šé«˜ï¼ˆç”¨å¹¾å±¤æ¨“æ¯”å–»ï¼‰ï¼Œä»¥åŠä»–ç‚ºä»€éº¼è¦ç«™åœ¨é€™è£¡ä¿è­·å¤§å®¶ã€‚')">
                        âœ¨ ä»‹ç´¹å·¨å‹æ©Ÿå™¨äºº
                    </button>
                     <a href="https://www.google.com/maps/search/?api=1&query=LaLaport+Fukuoka" target="_blank" class="btn-map">å°èˆªè‡³ LaLaport</a>
                    <div class="tags"><span class="tag tag-spot">é‹¼å½ˆ</span><span class="tag tag-kids">è¦ªå­å¿…éŠ</span><span class="tag tag-shop">è³¼ç‰©</span></div>
                </div>
                </div>
        </div>

    </div>

    <div id="view-stay" class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 1: ç†Šæœ¬ - THE BLOSSOM KUMAMOTO</div>
                <div class="tag tag-stay">å¸‚å€/è»Šç«™</div>
            </div>
            <div class="info-grid">
                <div class="info-label">åœ°å€</div>
                <div class="info-val">ç†Šæœ¬çœŒç†Šæœ¬å¸‚è¥¿åŒºæ˜¥æ—¥3ä¸ç›®15-26</div>
            </div>
             </div>
        </div>

    <div id="view-car" class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-title">èˆªç­è³‡è¨Š (ç†Šæœ¬é€²/ç¦å²¡å‡º)</div>
                <div class="tag tag-flight">æ˜Ÿå®‡èˆªç©º</div>
            </div>
             </div>
    </div>

    <div id="view-info" class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-title">Day 1: ç†Šæœ¬ ä¸Šé€š/ä¸‹é€š é€›è¡—æ”»ç•¥</div>
                <div class="tag tag-shop">è³¼ç‰©ç¾é£Ÿ</div>
            </div>
             </div>
    </div>

    <div id="view-ai" class="container">
        <div class="card" style="height: calc(100vh - 140px); min-height: 500px; display: flex; flex-direction: column;">
            <div class="ai-header" id="ai-modal-title">
                <span class="icon-mini">âœ¨</span>
                <span>éš¨èº« AI ç¿»è­¯èˆ‡åŠ©æ‰‹</span>
            </div>
            <div style="text-align: right; margin-bottom: 5px; padding-right: 5px;">
                <button onclick="resetAppPassword()" style="border: none; background: none; color: #EF4444; font-size: 0.85rem; cursor: pointer; text-decoration: underline; display: inline-flex; align-items: center;">
                    <span style="margin-right: 4px;">ğŸ”</span>
                    é‡è¨­é‡‘é‘°å¯†ç¢¼
                </button>
            </div>
            <div class="chat-history" id="chat-history">
                </div>

            <div class="ai-input-group" id="ai-input-area" style="display: block; margin-top: auto;">
                <div class="ai-input-wrapper">
                    <input type="text" class="ai-input" id="ai-user-input" placeholder="è«‹è¼¸å…¥å…§å®¹..." onkeypress="handleEnter(event)">
                    
                    <div class="voice-lang-switch">
                        <span style="font-weight:600; color:#9CA3AF; font-size:0.75rem; display: flex; align-items: center; gap: 4px;">
                            <span class="icon-mini">ğŸ—£ï¸</span>
                            èª°åœ¨èªªè©±:
                        </span>
                        
                        <label class="lang-option" title="æˆ‘ (èªªä¸­æ–‡)">
                            <input type="radio" name="voice_lang" value="zh-TW" checked onchange="updatePlaceholder()">
                            <span class="flag-icon">ğŸ‡¹ğŸ‡¼</span>
                        </label>
                        
                        <label class="lang-option" title="åº—å“¡ (èªªæ—¥æ–‡)">
                            <input type="radio" name="voice_lang" value="ja-JP" onchange="updatePlaceholder()">
                            <span class="flag-icon">ğŸ‡¯ğŸ‡µ</span>
                        </label>
                    </div>

                    <div class="ai-actions-row">
                        <button class="btn-mode consult" onclick="sendToGemini('consult')">
                            <span class="btn-mode-icon">ğŸ¤”</span>
                            è¡Œç¨‹è«®è©¢
                        </button>
                        <button class="btn-mode trans" onclick="sendToGemini('translate')">
                            <span class="btn-mode-icon">ğŸŒ</span>
                            ä¸­/æ—¥ç¿»è­¯
                        </button>
                        <button class="btn-mode voice" id="btn-voice-ja">
                            <span class="btn-mode-icon">ğŸ™ï¸</span>
                            èªéŸ³è¼¸å…¥
                        </button>
                    </div>
                </div>
            </div>
            
            <button id="btn-back-trans" class="btn-ai-reset" onclick="showAiTranslatorMode()">
                 â†©ï¸ è¿”å›ä¸€èˆ¬æ¨¡å¼
            </button>
        </div>
    </div>

    <div id="view-weather" class="container">
        <div class="card">
            <div class="card-header">
                <div class="card-title" style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 1.2rem;">ğŸŒ</span>
                    å³æ™‚å¤©æ°£æŸ¥è©¢ & ç©¿è¡£å»ºè­°
                </div>
            </div>
            
            <div class="weather-search-box">
                <input type="text" id="weather-city-input" class="weather-input" placeholder="è¼¸å…¥åŸå¸‚ (ä¾‹å¦‚: ç†Šæœ¬, ç”±å¸ƒé™¢)">
                <button class="btn-weather-search" onclick="fetchRealtimeWeather()">æŸ¥è©¢</button>
            </div>

            <div id="weather-result" style="display:none;">
                <div class="weather-card-main">
                    <div class="wc-loc" id="wc-loc">--</div>
                    <div class="wc-temp-big" id="wc-temp">--Â°</div>
                    <div class="wc-desc" id="wc-desc">è¼‰å…¥ä¸­...</div>
                </div>

                <div class="weather-compare-row">
                    <div class="wc-mini-card" onclick="getLocalWeather()" style="cursor:pointer; background:#F9FAFB;">
                        <div class="wc-mini-title" style="display: flex; align-items: center; justify-content: center;">
                            <span class="icon-mini">ğŸ“</span>
                            æˆ‘çš„ä½ç½® (é»æ“Šæ›´æ–°)
                        </div>
                        <div class="wc-mini-temp" id="wc-my-temp">--Â°</div>
                    </div>
                    <div class="wc-mini-card">
                        <div class="wc-mini-title" style="display: flex; align-items: center; justify-content: center;">
                            <span class="icon-mini">ğŸŒ¡ï¸</span>
                            æº«å·®å°æ¯”
                        </div>
                        <div id="wc-diff-tag" class="wc-diff-tag" style="display:none;">--</div>
                        <div id="wc-diff-text" style="font-size:0.8rem; color:#666; margin-top:2px;">--</div>
                    </div>
                </div>

                <div class="advice-box">
                    <strong style="display: flex; align-items: center; gap: 4px;">
                        <span class="icon-mini">ğŸ‘•</span>
                        AI ç©¿è¡£å»ºè­°ï¼š
                    </strong>
                    <div style="margin-top: 5px;" id="wc-advice">åˆ†ææ°£å€™æ•¸æ“šä¸­...</div>
                </div>
                
                <div style="font-size: 0.75rem; color: #9CA3AF; text-align: center; margin-top: 15px;">
                    * å¤©æ°£æ•¸æ“šä¾†æºï¼šOpen-Meteo Real-time API<br>
                    * ç©¿è¡£å»ºè­°ç”± Google Gemini AI åˆ†æç”Ÿæˆ
                </div>
            </div>
            
            <div id="weather-placeholder" style="text-align: center; padding: 40px; color: #9CA3AF;">
                <div style="font-size: 3rem; margin-bottom: 10px; opacity: 0.3;">â˜ï¸</div>
                <div>è«‹è¼¸å…¥åŸå¸‚åç¨±æŸ¥è©¢å³æ™‚å¤©æ°£</div>
            </div>
        </div>
    </div>

    <div id="location-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">æ‰‹å‹•è¨­å®šä½ç½®</div>
            <div class="modal-desc" id="modal-msg">ç„¡æ³•å–å¾— GPS å®šä½ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æ‚¨æ‰€åœ¨çš„åŸå¸‚ä»¥é€²è¡Œæº«å·®æ¯”å°ã€‚</div>
            <input type="text" id="modal-city-input" class="modal-input" placeholder="ä¾‹å¦‚: å°åŒ—, Taichung" value="å°åŒ—">
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="submitManualLocation()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <div class="nav-item active" data-target="view-schedule" onclick="switchTab(this)">
            <span class="nav-icon">ğŸ“…</span>
            è¡Œç¨‹è¡¨
        </div>
        <div class="nav-item" data-target="view-stay" onclick="switchTab(this)">
            <span class="nav-icon">ğŸ¨</span>
            ä½å®¿è³‡è¨Š
        </div>
        <div class="nav-item" data-target="view-car" onclick="switchTab(this)">
            <span class="nav-icon">ğŸš—</span>
            äº¤é€šè³‡è¨Š
        </div>
        <div class="nav-item" data-target="view-info" onclick="switchTab(this)">
            <span class="nav-icon">â„¹ï¸</span>
            æ—…éŠè³‡è¨Š
        </div>
        <div class="nav-item" data-target="view-weather" onclick="switchTab(this)">
            <span class="nav-icon">ğŸŒ¤ï¸</span>
            å³æ™‚å¤©æ°£
        </div>
        <div class="nav-item" data-target="view-ai" onclick="switchTab(this)">
            <span class="nav-icon">ğŸ¤–</span>
            AI åŠ©æ‰‹
        </div>
    </nav>

    <script>
        const encryptedApiKey = "U2FsdGVkX1/64ozwLOVc7Q7oTx058ndDWtXLLJ6Ri7cafbqjyyabFrsg2GixFXZV8bGjn7m7O7ZkH4CKCQjIjA=="; 
        let apiKey = ""; 

        function getDecryptedKey() {
            if (apiKey) return apiKey;
            let password = localStorage.getItem("app_password");
            if (!password) { password = prompt("è«‹è¼¸å…¥ API é‡‘é‘°å¯†ç¢¼ä»¥è§£é– AI åŠŸèƒ½ï¼š"); }
            if (!password) return null;
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedApiKey, password);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);
                if (originalText.startsWith("AIza")) {
                    apiKey = originalText;
                    localStorage.setItem("app_password", password);
                    return apiKey;
                } else {
                    alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•è§£å¯† API Keyã€‚");
                    localStorage.removeItem("app_password");
                    return null;
                }
            } catch (e) {
                console.error("è§£å¯†å¤±æ•—", e);
                alert("è§£å¯†å¤±æ•—ï¼Œè«‹ç¢ºèªå¯†ç¢¼ã€‚");
                localStorage.removeItem("app_password");
                return null;
            }
        }
        
        // [ä¿®æ”¹] Weather Icons - å°‡åŸæœ¬çš„ SVG å­—ä¸²æ”¹ç‚º Emoji
        const weatherIcons = {
            'sun': 'â˜€ï¸',
            'cloud': 'â˜ï¸',
            'cloud-sun': 'â›…',
            'rain': 'ğŸŒ§ï¸',
            'snow': 'â„ï¸'
        };

        const weatherData = {
            'd1': { loc: 'ç†Šæœ¬å¸‚', date: '1/25 (Day 1)', temp: '10Â°C', range: '2Â°C ~ 11Â°C', desc: 'æ™´æ™‚å¤šé›²', advice: 'æ°£æº«é©ä¸­ä½†æ—©æ™šåæ¶¼ï¼Œé•·è¢–é…å¤–å¥—ã€‚', icon: 'cloud-sun' },
            'd2': { loc: 'é˜¿è˜‡/é»‘å·', date: '1/26 (Day 2)', temp: '5Â°C', range: '-3Â°C ~ 6Â°C', desc: 'å¤šé›²/é£„é›ª', advice: 'å±±å€æ¥µå†·ï¼Œå‹™å¿…ç©¿è‘—ç¾½çµ¨å¤–å¥—ä¿æš–ã€‚', icon: 'snow' },
            'd3': { loc: 'åˆ¥åºœ/ç”±å¸ƒé™¢', date: '1/27 (Day 3)', temp: '7Â°C', range: '0Â°C ~ 8Â°C', desc: 'å¤šé›²', advice: 'æ¿•åº¦è¼ƒé«˜é«”æ„Ÿå¯’å†·ï¼Œè«‹ç©¿é˜²æ»‘é‹ã€‚', icon: 'cloud' },
            'd4': { loc: 'ç¦å²¡å¸‚', date: '1/28 (Day 4)', temp: '9Â°C', range: '4Â°C ~ 10Â°C', desc: 'é™°å¤©', advice: 'å¸‚å€é¢¨å¤§ï¼Œå»ºè­°ç©¿è‘—é˜²é¢¨å¤–å¥—ã€‚', icon: 'cloud' },
            'd5': { loc: 'ç¦å²¡å¸‚', date: '1/29 (Day 5)', temp: '10Â°C', range: '3Â°C ~ 11Â°C', desc: 'æ™´æœ—', advice: 'æ—©æ™šæº«å·®å¤§ï¼Œæ´‹è”¥å¼ç©¿æ³•æœ€ä½³ã€‚', icon: 'sun' },
            'd6': { loc: 'ç¦å²¡å¸‚', date: '1/30 (Day 6)', temp: '9Â°C', range: '4Â°C ~ 10Â°C', desc: 'å¤šé›²æ™‚æ™´', advice: 'å®¤å…§æš–æ°£å¼·ï¼Œå…§æ­ä¸å®œéåšã€‚', icon: 'cloud-sun' }
        };

        function updateWeatherWidget(dayId) {
            const data = weatherData[dayId];
            if (data) {
                document.getElementById('hw-loc').innerText = data.loc;
                document.getElementById('hw-date').innerText = data.date;
                document.getElementById('hw-temp').innerText = data.temp; 
                document.getElementById('hw-desc').innerText = data.desc;
                document.getElementById('hw-range').innerText = data.range;
                document.getElementById('hw-advice').innerText = data.advice;
                // [ä¿®æ”¹] ç›´æ¥é¡¯ç¤º Emojiï¼Œä¸éœ€è¦ SVG wrapper
                const iconEmoji = weatherIcons[data.icon] || weatherIcons['cloud'];
                document.getElementById('hw-icon').innerText = iconEmoji;
            }
        }
                
        // --- REAL-TIME WEATHER FUNCTIONS ---
        let currentMyTemp = null;
        const cityMapping = {
            'ç”±å¸ƒé™¢': 'Yufuin', 'æ¹¯å¸ƒé™¢': 'Yufuin', 'é»‘å·': 'Minamioguni', 'é»‘å·æº«æ³‰': 'Minamioguni',
            'ç†Šæœ¬': 'Kumamoto', 'ç†Šæœ¬å¸‚': 'Kumamoto', 'é˜¿è˜‡': 'Aso', 'åˆ¥åºœ': 'Beppu',
            'ç¦å²¡': 'Fukuoka', 'åšå¤š': 'Fukuoka', 'å¤ªå®°åºœ': 'Dazaifu', 'é«˜åƒç©—': 'Takachiho'
        };

        async function getGeminiResponse(promptText) {
            const currentKey = getDecryptedKey();
            if (!currentKey) {
                appendMessage('ai', 'âš ï¸ å°šæœªè¼¸å…¥æ­£ç¢ºå¯†ç¢¼ï¼Œç„¡æ³•ä½¿ç”¨ AI åŠŸèƒ½ã€‚');
                throw new Error("API Key Missing");
            }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                let text = data.candidates[0].content.parts[0].text.trim();
                text = text.replace(/```(html|json)?/g, '').replace(/```/g, '').trim();
                return text;
            } catch (error) {
                console.error("AI Fetch Error:", error);
                throw error;
            }
        }

        async function fetchRealtimeWeather() {
            const rawInput = document.getElementById('weather-city-input').value.trim();
            if (!rawInput) { alert('è«‹è¼¸å…¥åŸå¸‚åç¨±'); return; }

            document.getElementById('weather-placeholder').style.display = 'none';
            document.getElementById('weather-result').style.display = 'block';
            document.getElementById('wc-loc').innerText = rawInput; 
            document.getElementById('wc-desc').innerText = 'æº–å‚™ä¸­...';
            document.getElementById('wc-temp').innerText = '--Â°';
            document.getElementById('wc-advice').innerText = '...';

            let searchTerm = rawInput;
            let isTranslated = false;

            try {
                for (const key in cityMapping) {
                    if (rawInput.includes(key)) {
                        searchTerm = cityMapping[key];
                        isTranslated = true;
                        break;
                    }
                }

                if (!isTranslated) {
                    document.getElementById('wc-desc').innerText = 'ğŸ” AI æ­£åœ¨ç¿»è­¯åœ°å...';
                    const translatePrompt = `Task: Translate "${rawInput}" to English Romanization for Weather API. Rule: Output ONLY the English name.`;
                    try {
                        const aiTranslation = await getGeminiResponse(translatePrompt);
                        if (/^[a-zA-Z\s\-,]+$/.test(aiTranslation)) {
                            searchTerm = aiTranslation;
                            isTranslated = true;
                        }
                    } catch (e) { console.warn("AI ç¿»è­¯å¤±æ•—"); }
                }

                document.getElementById('wc-desc').innerText = 'é€£ç·šæ°£è±¡è¡›æ˜Ÿ...';
                let geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchTerm)}&count=10&language=en&format=json`;
                let geoRes = await fetch(geoUrl);
                let geoData = await geoRes.json();

                if ((!geoData.results || geoData.results.length === 0) && isTranslated) {
                     geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(rawInput)}&count=10&language=zh&format=json`;
                     geoRes = await fetch(geoUrl);
                     geoData = await geoRes.json();
                }

                if (!geoData.results || geoData.results.length === 0) {
                     throw new Error(`æ‰¾ä¸åˆ°ã€Œ${rawInput}ã€<br>AI ç¿»è­¯: ${searchTerm}`);
                }

                let targetLocation = geoData.results[0];
                const jpLocation = geoData.results.find(r => r.country_code === 'JP' || r.country === 'Japan');
                if (jpLocation) { targetLocation = jpLocation; }

                const { latitude, longitude } = targetLocation;
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
                const weatherRes = await fetch(weatherUrl);
                const weatherData = await weatherRes.json();

                const temp = weatherData.current_weather.temperature;
                const weatherCode = weatherData.current_weather.weathercode;

                let displayLocHtml = rawInput;
                if (searchTerm && searchTerm.toLowerCase() !== rawInput.toLowerCase()) {
                    displayLocHtml = `<div style="display: flex; flex-direction: column; align-items: center; line-height: 1.2;"><span>${rawInput}</span><span style="font-size: 0.6em; opacity: 0.8; font-weight: 400; margin-top: 4px; font-family: sans-serif; letter-spacing: 0.5px;">${searchTerm}</span></div>`;
                }
                document.getElementById('wc-loc').innerHTML = displayLocHtml;
                document.getElementById('wc-temp').innerText = `${temp}Â°C`;
                document.getElementById('wc-desc').innerHTML = getWeatherDesc(weatherCode);

                updateComparison(temp);
                document.getElementById('wc-advice').innerText = 'AI æ­£åœ¨åˆ†æç•¶åœ°æ°£å€™...';
                askAiWeatherAdvice(rawInput, temp, getWeatherDesc(weatherCode));

            } catch (error) {
                console.error(error);
                document.getElementById('wc-desc').innerText = 'æŸ¥è©¢å¤±æ•—';
                let errorMsg = error.message;
                if (errorMsg.includes('Failed to fetch')) errorMsg = 'ç¶²è·¯é€£ç·šè¢«é˜»æ“‹';
                document.getElementById('wc-advice').innerHTML = `<span style="color:var(--danger); font-weight:bold;">${errorMsg}</span>`;
            }
        }

        // [ä¿®æ”¹] ç°¡æ˜“å¤©æ°£åœ–ç¤º (ç”¨æ–¼å³æ™‚å¤©æ°£) - æ”¹ç‚º Emoji
        const simpleIcons = {
            sun: 'â˜€ï¸',
            cloud: 'â˜ï¸',
            rain: 'ğŸŒ§ï¸',
            snow: 'â„ï¸',
            fog: 'ğŸŒ«ï¸',
            lightning: 'â›ˆï¸'
        };

        function getWeatherDesc(code) {
            // [ä¿®æ”¹] å›å‚³ Emoji å­—ä¸²
            if (code === 0) return `æ™´æœ— ${simpleIcons.sun}`;
            if (code >= 1 && code <= 3) return `å¤šé›² ${simpleIcons.cloud}`;
            if (code >= 45 && code <= 48) return `æœ‰éœ§ ${simpleIcons.fog}`;
            if (code >= 51 && code <= 67) return `æœ‰é›¨ ${simpleIcons.rain}`;
            if (code >= 71 && code <= 77) return `æœ‰é›ª ${simpleIcons.snow}`;
            if (code >= 80 && code <= 82) return `é™£é›¨ ${simpleIcons.rain}`;
            if (code >= 95) return `é›·é›¨ ${simpleIcons.lightning}`;
            return `å¤šé›² ${simpleIcons.cloud}`;
        }

        function getLocalWeather() {
            const tempEl = document.getElementById('wc-my-temp');
            const titleEl = document.querySelector('.wc-mini-card .wc-mini-title');
            
            if (!navigator.geolocation) { openModal('ç€è¦½å™¨ä¸æ”¯æ´å®šä½ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åŸå¸‚ï¼š'); return; }
            
            tempEl.innerText = 'å®šä½ä¸­..'; tempEl.style.fontSize = '1.2rem'; tempEl.style.color = '#2563EB'; 
            titleEl.innerHTML = 'æ­£åœ¨è®€å– GPS...';

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                try {
                    const weatherPromise = fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`).then(res => res.json());
                    const locationPrompt = `Task: Identify city name for ${lat}, ${lon}. Output: "Traditional Chinese|English".`;
                    const locationPromise = getGeminiResponse(locationPrompt);
                    const [weatherData, locationStr] = await Promise.all([weatherPromise, locationPromise]);
                    
                    currentMyTemp = weatherData.current_weather.temperature;
                    tempEl.innerText = `${currentMyTemp}Â°C`;
                    tempEl.style.fontSize = '1.5rem'; tempEl.style.color = '#1F2937'; 
                    
                    let displayZh = "æˆ‘çš„ä½ç½®", displayEn = "";
                    if (locationStr && locationStr.includes('|')) {
                        const parts = locationStr.split('|'); displayZh = parts[0].trim(); displayEn = parts[1].trim();
                    } else if (locationStr) { displayZh = locationStr.trim(); }

                    // [ä¿®æ”¹] ä½¿ç”¨ Emoji
                    let titleHtml = `<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;"><div style="display: flex; align-items: center; gap: 4px;"><span class="icon-mini">ğŸ“</span><span>${displayZh}</span></div>`;
                    if (displayEn) { titleHtml += `<span style="font-size: 0.75rem; color: #9CA3AF; font-weight: 400; font-family: sans-serif;">${displayEn}</span>`; }
                    titleHtml += `</div>`;
                    titleEl.innerHTML = titleHtml;

                    const targetTempStr = document.getElementById('wc-temp').innerText;
                    if (targetTempStr !== '--Â°') { updateComparison(parseFloat(targetTempStr)); }
                } catch (e) {
                    console.error(e); tempEl.innerText = 'Err';
                    titleEl.innerHTML = `<div style="display: flex; align-items: center; justify-content: center;"><span class="icon-mini">ğŸ“</span>æˆ‘çš„ä½ç½® (é‡è©¦)</div>`;
                    openModal('è®€å–æ°£è±¡æ•¸æ“šå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åŸå¸‚ï¼š');
                }
            }, (err) => {
                let shortMsg = 'å®šä½å¤±æ•—';
                if (err.code === 1) shortMsg = 'ç„¡æ¬Šé™'; 
                if (err.code === 2) shortMsg = 'è¨Šè™Ÿä¸è‰¯'; 
                if (err.code === 3) shortMsg = 'é€¾æ™‚'; 
                tempEl.innerText = shortMsg; tempEl.style.fontSize = '1rem'; tempEl.style.color = '#EF4444'; 
                setTimeout(() => { openModal(`å®šä½å—é™ (${shortMsg})ï¼Œæ”¹ç‚ºæ‰‹å‹•è¼¸å…¥ï¼Ÿ`); }, 300);
            }, { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 });
        }

        // --- Modal Functions ---
        function openModal(msg) {
            document.getElementById('modal-msg').innerText = msg;
            document.getElementById('location-modal').style.display = 'flex';
            document.getElementById('modal-city-input').focus();
        }
        function closeModal() { document.getElementById('location-modal').style.display = 'none'; }

        async function submitManualLocation() {
            const manualCity = document.getElementById('modal-city-input').value.trim();
            if (!manualCity) return;
            closeModal();
            const tempEl = document.getElementById('wc-my-temp');
            tempEl.innerText = 'æŸ¥è©¢ä¸­..'; tempEl.style.color = '#2563EB'; tempEl.style.fontSize = '1.2rem';
            
            let searchTerm = manualCity; let isTranslated = false;
            for (const key in cityMapping) { if (manualCity.includes(key)) { searchTerm = cityMapping[key]; isTranslated = true; break; } }
            if (!isTranslated) {
                tempEl.innerText = 'ç¿»è­¯ä¸­..';
                const translatePrompt = `Task: Translate "${manualCity}" to English Romanization. Rule: Output ONLY English.`;
                try {
                    const aiTranslation = await getGeminiResponse(translatePrompt);
                    if (/^[a-zA-Z\s\-,]+$/.test(aiTranslation)) { searchTerm = aiTranslation; isTranslated = true; }
                } catch (e) {}
            }
            tempEl.innerText = 'é€£ç·šä¸­..';

            try {
                let geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchTerm)}&count=10&language=en&format=json`;
                let geoRes = await fetch(geoUrl); let geoData = await geoRes.json();
                if ((!geoData.results || geoData.results.length === 0) && isTranslated) {
                    geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(manualCity)}&count=10&language=zh&format=json`;
                    geoRes = await fetch(geoUrl); geoData = await geoRes.json();
                }
                if (!geoData.results || geoData.results.length === 0) {
                    tempEl.innerText = 'æŸ¥ç„¡æ­¤åœ°';
                    setTimeout(() => openModal(`æ‰¾ä¸åˆ°ã€Œ${manualCity}ã€(ç¿»è­¯: ${searchTerm})ï¼Œè«‹å˜—è©¦è¼¸å…¥å…¶ä»–åç¨±ï¼š`), 1000); return;
                }
                let targetLocation = geoData.results[0];
                const jpLocation = geoData.results.find(r => r.country_code === 'JP' || r.country === 'Japan');
                if (jpLocation) { targetLocation = jpLocation; }

                const { latitude, longitude } = targetLocation;
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
                const weatherRes = await fetch(weatherUrl); const weatherData = await weatherRes.json();

                currentMyTemp = weatherData.current_weather.temperature;
                tempEl.innerText = `${currentMyTemp}Â°C`; tempEl.style.fontSize = '1.5rem'; tempEl.style.color = '#1F2937';
                
                const titleEl = document.querySelector('.wc-mini-card .wc-mini-title');
                let titleHtml = `<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;"><div style="display: flex; align-items: center; gap: 4px;"><span class="icon-mini">ğŸ“</span><span>${manualCity}</span></div>`;
                if (searchTerm && searchTerm.toLowerCase() !== manualCity.toLowerCase()) { titleHtml += `<span style="font-size: 0.75rem; color: #9CA3AF; font-weight: 400; font-family: sans-serif;">${searchTerm}</span>`; }
                titleHtml += `</div>`;
                titleEl.innerHTML = titleHtml;

                const targetTempStr = document.getElementById('wc-temp').innerText;
                if (targetTempStr !== '--Â°') { updateComparison(parseFloat(targetTempStr)); }
            } catch (e) { console.error(e); tempEl.innerText = 'å¤±æ•—'; tempEl.style.color = '#EF4444'; }
        }

        function updateComparison(targetTemp) {
            if (currentMyTemp === null) { getLocalWeather(); return; }
            const diff = targetTemp - currentMyTemp;
            const diffTag = document.getElementById('wc-diff-tag');
            const diffText = document.getElementById('wc-diff-text');
            diffTag.style.display = 'inline-block';
            if (diff > 0) { diffTag.className = 'wc-diff-tag wc-diff-hot'; diffTag.innerText = `ç†± ${diff.toFixed(1)}Â°C`; diffText.innerText = 'æ¯”é€™è£¡æº«æš–'; } 
            else { diffTag.className = 'wc-diff-tag wc-diff-cold'; diffTag.innerText = `å†· ${Math.abs(diff).toFixed(1)}Â°C`; diffText.innerText = 'æ¯”é€™è£¡å†·'; }
        }

        async function askAiWeatherAdvice(city, temp, condition) {
            const prompt = `ç¾åœ¨${city}æ°£æº« ${temp}åº¦ï¼Œå¤©æ°£${condition}ã€‚è«‹ä»¥ã€Œæ—…éŠå°ç§˜æ›¸ã€å£å»çµ¦äºˆå°ç£æ—…å®¢50å­—å…§ç©¿è¡£å»ºè­°(å«é«”æ„Ÿæè¿°)ã€‚`;
            try { const text = await getGeminiResponse(prompt); document.getElementById('wc-advice').innerText = text; } 
            catch (e) { document.getElementById('wc-advice').innerText = 'AI é€£ç·šé€¾æ™‚ï¼Œå»ºè­°æ´‹è”¥å¼ç©¿æ­ã€‚'; }
        }
        
        // --- UI Interaction ---
        function switchTab(element) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.container').forEach(container => container.classList.remove('active'));
            element.classList.add('active');
            const targetId = element.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');
            window.scrollTo(0, 0);
        }

        function toggleTimeline(id, toggleElement) {
            const timeline = document.getElementById(id);
            if (!timeline.classList.contains('show')) {
                document.querySelectorAll('.timeline.show').forEach(t => t.classList.remove('show'));
                document.querySelectorAll('.day-toggle.open').forEach(t => t.classList.remove('open'));
                timeline.classList.add('show'); toggleElement.classList.add('open');
                updateWeatherWidget(id);
            } else {
                timeline.classList.remove('show'); toggleElement.classList.remove('open');
            }
        }

        const chatHistory = document.getElementById('chat-history');
        const aiInput = document.getElementById('ai-user-input');
        const aiTitle = document.getElementById('ai-modal-title');
        const aiInputArea = document.getElementById('ai-input-area');
        const btnBackTrans = document.getElementById('btn-back-trans');

        function initAiChat() {
            if (chatHistory.children.length === 0) {
                appendMessage('ai', `ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ä¹å·æ—…éŠ AI åŠ©æ‰‹ã€‚<br><br>ä½ å¯ä»¥é»é¸ä¸‹æ–¹çš„ <b>ã€Œè¡Œç¨‹è«®è©¢ã€</b> è©¢å•è·¯ç·šï¼Œæˆ–ä½¿ç”¨ <b>ã€Œä¸­/æ—¥ç¿»è­¯ã€</b> èˆ‡ç•¶åœ°äººæºé€šã€‚`);
            }
        }

        function goToAiTab() { switchTab(document.querySelector('[data-target="view-ai"]')); }

        function showAiTranslatorMode() {
            // [ä¿®æ”¹] æ¨™é¡Œåœ–ç¤ºæ”¹ç‚º Emoji
            aiTitle.innerHTML = '<span class="icon-mini">âœ¨</span><span>éš¨èº« AI ç¿»è­¯èˆ‡åŠ©æ‰‹</span>';
            aiInputArea.style.display = 'block'; btnBackTrans.style.display = 'none';
            chatHistory.scrollTop = chatHistory.scrollHeight; setupVoiceButton();
        }
        
        function appendMessage(sender, htmlContent, isAudio = false) {
            const row = document.createElement('div'); row.className = `chat-row ${sender}`;
            const bubble = document.createElement('div'); bubble.className = `chat-bubble ${sender}`; bubble.innerHTML = htmlContent;
            
            if (sender === 'ai' && isAudio) {
                const btn = document.createElement('button'); btn.className = 'btn-audio-inline';
                // [ä¿®æ”¹] æ’­æ”¾æŒ‰éˆ•åœ–ç¤ºæ”¹ç‚º Emoji
                btn.innerHTML = 'ğŸ”Š';
                const textToSpeak = bubble.innerText.replace('ğŸ”Š', '').trim();
                btn.onclick = () => speakText(textToSpeak);
                bubble.appendChild(btn);
                setTimeout(() => speakText(textToSpeak), 200);
            }
            row.appendChild(bubble); chatHistory.appendChild(row);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            return bubble;
        }
        
        function showLoading() {
            const row = document.createElement('div'); row.className = 'chat-row ai loading-row'; row.id = 'loading-indicator';
            const bubble = document.createElement('div'); bubble.className = 'chat-bubble ai loading-bubble'; bubble.innerHTML = 'AI æ­£åœ¨æ€è€ƒä¸­<span class="loading-dots"></span>';
            row.appendChild(bubble); chatHistory.appendChild(row); chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function removeLoading() { const loading = document.getElementById('loading-indicator'); if (loading) loading.remove(); }
        
        function updatePlaceholder() {
            const lang = document.querySelector('input[name="voice_lang"]:checked').value;
            document.getElementById('ai-user-input').placeholder = lang === 'zh-TW' ? 'è«‹è¼¸å…¥ä¸­æ–‡ (æˆ–ä½¿ç”¨èªéŸ³)...' : 'è«‹è¼¸å…¥æ—¥æ–‡ (æˆ–åˆ‡æ›èªéŸ³)...';
        }

        function speakText(text) {
             speechSynthesis.cancel();
             const utterance = new SpeechSynthesisUtterance(text);
             utterance.lang = 'ja-JP'; utterance.rate = 0.9;
             const voices = speechSynthesis.getVoices();
             const jaVoice = voices.find(v => v.lang.includes('ja'));
             if (jaVoice) utterance.voice = jaVoice;
             speechSynthesis.speak(utterance);
        }

        function setupVoiceButton() {
            const voiceBtn = document.getElementById('btn-voice-ja');
            if (!voiceBtn) return;
            voiceBtn.oncontextmenu = function(event) { event.preventDefault(); event.stopPropagation(); return false; };
            let recognition;
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false; recognition.interimResults = false;
                recognition.onstart = function() {
                    const selectedLang = document.querySelector('input[name="voice_lang"]:checked').value;
                    recognition.lang = selectedLang;
                    voiceBtn.classList.add('recording');
                    const langText = selectedLang === 'zh-TW' ? 'ä¸­æ–‡' : 'æ—¥æ–‡';
                    // [ä¿®æ”¹] éŒ„éŸ³ç‹€æ…‹åœ–ç¤ºæ”¹ç‚º Emoji
                    voiceBtn.innerHTML = `ğŸ”´ è½${langText}ä¸­...`;
                    document.getElementById('ai-user-input').placeholder = `æ­£åœ¨è†è½${langText}...`;
                };
                recognition.onend = function() {
                    voiceBtn.classList.remove('recording');
                    // [ä¿®æ”¹] èªéŸ³æŒ‰éˆ•é‚„åŸç‚º Emoji
                    voiceBtn.innerHTML = `<span class="btn-mode-icon">ğŸ™ï¸</span>èªéŸ³è¼¸å…¥`;
                    updatePlaceholder();
                };
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('ai-user-input').value = transcript;
                    sendToGemini('voice_auto');
                };
                recognition.onerror = function(event) {
                    console.log('Voice Error:', event.error);
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = `<span class="btn-mode-icon">ğŸ”„</span>é‡è©¦`;
                };
                voiceBtn.onclick = (e) => {
                    if (e.cancelable) e.preventDefault();
                    try { recognition.stop(); } catch(err) {}
                    try { recognition.start(); } catch(err) { console.log(err); }
                };
            } else {
                voiceBtn.style.display = 'none'; console.log('Web Speech API not supported');
            }
        }

        function askGeminiGuide(spotName, customPrompt) {
            goToAiTab();
            // [ä¿®æ”¹] æ¨™é¡Œåœ–ç¤ºæ”¹ç‚º Emoji
            aiTitle.innerHTML = `<span class="icon-mini">âœ¨</span><span>${spotName} å°æ•…äº‹</span>`;
            aiInputArea.style.display = 'none'; btnBackTrans.style.display = 'block'; 
            appendMessage('ai', `æ­£åœ¨ç‚ºæ‚¨ç”Ÿæˆé—œæ–¼ã€Œ${spotName}ã€çš„æ•…äº‹...`);
            const prompt = `ä½ æ˜¯ä¸€ä½å¸¶é ˜è¦ªå­æ—…éŠçš„ä¹å·å°éŠã€‚è«‹é‡å°æ™¯é»ã€Œ${spotName}ã€ç”Ÿæˆä¸€æ®µçµ¦ 5-8 æ­²å°å­©è½çš„å°è¦½è©ã€‚è¦æ±‚ï¼š1. èªæ°£ç”Ÿå‹•æ´»æ½‘ï¼Œä½¿ç”¨å°ç£ç¹é«”ä¸­æ–‡ã€‚2. åŒ…å«å†·çŸ¥è­˜ã€‚3. çµ¦å­©å­ä¸€å€‹è§€å¯Ÿä»»å‹™ã€‚4. é•·åº¦150å­—å…§ã€‚5. ${customPrompt}`;
            callGemini(prompt);
        }

        function handleEnter(e) { if (e.key === 'Enter') sendToGemini('auto'); }

        function sendToGemini(mode) {
            const text = aiInput.value.trim(); if (!text) return;
            appendMessage('user', text); aiInput.value = '';
            const scheduleContext = document.getElementById('view-schedule').innerText;
            let prompt = "";
            if (mode === 'consult') {
                prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¹å·è¦ªå­æ—…éŠé¡§å•ã€‚ã€è¡Œç¨‹è¡¨è³‡è¨Šã€‘ï¼š${scheduleContext.substring(0, 8000)}ã€ä½¿ç”¨è€…å•é¡Œã€‘ï¼š "${text}" ä»»å‹™ï¼šæä¾›å…·é«”å»ºè­°ï¼Œæ³¨æ„é«”åŠ›åˆ†é…èˆ‡å…’ç«¥éœ€æ±‚ã€‚`;
            } else if (mode === 'translate') {
                prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ä¸­æ—¥ç¿»è­¯æ©Ÿã€‚ã€ä½¿ç”¨è€…è¼¸å…¥ã€‘ï¼š "${text}" ä»»å‹™ï¼š1. ä¸­æ–‡ç¿»æ—¥æ–‡(ç¦®è²Œå½¢)ã€‚2. æ—¥æ–‡ç¿»ä¸­æ–‡ã€‚æ³¨æ„ï¼šåªçµ¦ç¿»è­¯çµæœï¼Œä¸è§£é‡‹ã€‚`;
            } else if (mode === 'voice_auto') {
                const selectedLang = document.querySelector('input[name="voice_lang"]:checked').value;
                const isInputZh = selectedLang === 'zh-TW';
                prompt = `ä½ æ˜¯ä¸€å€‹ä¸­æ—¥é›™å‘å£è­¯å“¡ã€‚ã€è¼¸å…¥èªè¨€ã€‘ï¼š${isInputZh ? 'ä¸­æ–‡' : 'æ—¥æ–‡'}ã€è¼¸å…¥ã€‘ï¼š "${text}" ä»»å‹™ï¼š${isInputZh ? 'ä¸­ç¿»æ—¥' : 'æ—¥ç¿»ä¸­'}ã€‚æ³¨æ„ï¼šåªç¿»è­¯ï¼Œä¸è§£é‡‹ã€‚`;
            } else {
                prompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ä¹å·è¦ªå­æ—…éŠé¡§å•èˆ‡éš¨èº«ç¿»è­¯ã€‚ã€è¡Œç¨‹è¡¨è³‡è¨Šã€‘ï¼š${scheduleContext.substring(0, 5000)}ã€ä½¿ç”¨è€…è¼¸å…¥ã€‘ï¼š "${text}" è«‹åˆ¤æ–·ï¼š1. è‹¥æ˜¯å•é¡Œ -> è¡Œç¨‹è«®è©¢ã€‚2. è‹¥æ˜¯çŸ­å¥ -> ç¿»è­¯ã€‚ç›´æ¥çµ¦å‡ºçµæœã€‚`;
            }
            callGemini(prompt);
        }

        async function callGemini(promptText) {
            showLoading();
            try {
                let rawText = await getGeminiResponse(promptText);
                removeLoading();
                const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF]/.test(rawText);
                const isTranslation = hasJapanese && rawText.length < 500;
                const formattedText = rawText.replace(/\n/g, '<br>');
                appendMessage('ai', formattedText, isTranslation);
            } catch (error) {
                removeLoading(); console.error('Gemini API Error:', error);
                appendMessage('ai', `<span style="color:red">ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚<br>Error: ${error.message}</span>`);
            }
        }
        function resetAppPassword() {
            if (confirm("æ‚¨ç¢ºå®šè¦æ¸…é™¤å·²è¨˜æ†¶çš„å¯†ç¢¼ä¸¦é‡æ–°è¼¸å…¥å—ï¼Ÿ")) {
                localStorage.removeItem("app_password"); alert("å¯†ç¢¼å·²æ¸…é™¤ï¼é é¢å°‡é‡æ–°æ•´ç†ï¼Œè«‹é‡æ–°è¼¸å…¥æ–°å¯†ç¢¼ã€‚"); window.location.reload();
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const d1Toggle = document.getElementById('toggle-d1'); const d1Timeline = document.getElementById('d1');
            if (d1Timeline) { d1Timeline.classList.add('show'); d1Toggle.classList.add('open'); updateWeatherWidget('d1'); }
            initAiChat(); setupVoiceButton();
        });
    </script>
</body>
</html>